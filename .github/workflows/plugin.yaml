name: Plugin
on:
  - push
  - pull_request
jobs:
  test-please_pex:
    name: Test (Python ${{ matrix.python }}, in-repo please_pex)
    uses: ./.github/workflows/plugin_test.yaml
    with:
      runner: ubuntu-latest
      python: ${{ matrix.python }}
      please_pex_from_repo: true
    strategy:
      fail-fast: false
      matrix:
        python:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
  test:
    name: Test (Python ${{ matrix.python }}, stable please_pex release)
    uses: ./.github/workflows/plugin_test.yaml
    with:
      runner: ubuntu-latest
      python: ${{ matrix.python }}
      please_pex_from_repo: false
    strategy:
      fail-fast: false
      matrix:
        python:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
  release-tools:
    name: Release tools
    if: github.ref == 'refs/heads/master'
    needs:
      - test-please_pex
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5
      - name: Build tools
        run: ./pleasew build //package:release_files
      - name: Release tools
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: thought-machine/release-action@master
        with:
          release-files: plz-out/package
          version-file: tools/VERSION
          change-log-file: tools/ChangeLog
          release-prefix: tools
  release-plugin:
    name: Release plugin
    if: github.ref == 'refs/heads/master'
    needs:
      - test
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5
      - name: Release plugin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: thought-machine/release-action@master
