# Nothing in here is actually used - we just need this to initialise CONFIG.PYTHON for this package.
subinclude("//build_defs:archs")

_python_build_standalone_release = "20251031"
_python_build_standalone_hashes = {
    "3.10.19": {
        "aarch64-apple-darwin": "24be196d33ee1b40393beff9df721ed596ec90b8be3f424122f1300f41a4a3b6",
        "aarch64-unknown-linux-gnu": "a04c0cf04f45b6f8966f693beef5b3929d88978a04de4a6ec0bf330d71e0ffd1",
        "aarch64-unknown-linux-musl": "e2ddd1e8980ecba2221074b9e3fccd10d0fbf1994974250eb537b066a0879e04",
        "x86_64-apple-darwin": "5f3a156f063f4a6fa522b1ebb724a7554a67be32318b69041e83fd77a2bd761c",
        "x86_64_v2-unknown-linux-gnu": "e5fe6913158b40b5ac897897c51c5879cac2684c435bf217774200fb863c9660",
        "x86_64_v2-unknown-linux-musl": "487fb8581280403300076b89b575def54c8b40143a1d84ed75432a08b134a024",
    },
    "3.11.14": {
        "aarch64-apple-darwin": "3ee35ef147a7ec7b62e4d5686742959f5a8ea557724a9cd183e0532a71cf3221",
        "aarch64-unknown-linux-gnu": "ed1840fa7baa762d3506c161ee1887c29c3603737058a22639cd88ed69e4be9d",
        "aarch64-unknown-linux-musl": "45dc662a82dae8db5dd706ddb7440e52ae2d521056b183488e1ce436a19530f3",
        "x86_64-apple-darwin": "7d283bcbfaf0204b98d9d0f4eea216fc41220f67739d60b89fb91f88e551b8fb",
        "x86_64_v2-unknown-linux-gnu": "b8679afca4481dc382fa44cf467d87f4b3b89ed3aa956e1ac4280ca235dbe560",
        "x86_64_v2-unknown-linux-musl": "a28d67ca4d5d1277b260d5e5529ce99bcff503db76f9625375fb700056a424ca",
    },
    "3.12.12": {
        "aarch64-apple-darwin": "2539a9105e47237aa8caabeed20587778f4acf9c6c4b3fe77f9bc2fd320720d2",
        "aarch64-unknown-linux-gnu": "05fb2e3fb98efca19e7bc5740646e0639afc3b573f580384592c212b0a4cd8c3",
        "aarch64-unknown-linux-musl": "3c30908c00027ecbd80d5f90b6e45c57230e0d81de5f051104bb91072fa24c75",
        "x86_64-apple-darwin": "10538a63ce7aa4d0891a3181150159fb5d3b750470a638ef8255a25dc50b9961",
        "x86_64_v2-unknown-linux-gnu": "009534a3a6a0b78054fd9c93943d894a89a8ee3318501c92a0b9684e903bdda9",
        "x86_64_v2-unknown-linux-musl": "e795c4e4fb24874e36df58ff7af50fdfc3fdb5ebee73f60fb81eb1a5218a34f5",
    },
    "3.13.9": {
        "aarch64-apple-darwin": "6924bd5fbf74dba25cf733a91deebe313e91f26f261aec8c1d0dc4cb8a9d8738",
        "aarch64-unknown-linux-gnu": "0cbb7b12215e000224f0834543ab4ad02d88c9b772198e2ab80311aff6dbc294",
        "aarch64-unknown-linux-musl": "a7ddc8c5970971f533ca05edae9378638ba52de6054bd0e6399dafac7ba790a8",
        "x86_64-apple-darwin": "b79e2e45b38cf4c8743c61745fe33de95912866d8d81bd97ddff3477098420f9",
        "x86_64_v2-unknown-linux-gnu": "02e055d1168e926491d6ec35745d1be0ffaa60bae56ab4c44aafbffbdac9178c",
        "x86_64_v2-unknown-linux-musl": "85b219bb03abec4873ec53dc06039b71ff7500baaaa52903896b5e1e17a1911c",
    },
    "3.14.0": {
        "aarch64-apple-darwin": "4d37c50912b533913fe4a6f0239acb737d65dc6dad72096c4573b755c6b26712",
        "aarch64-unknown-linux-gnu": "04c0886b0fa9eecb9c2a768ae554c9a6b494ba9f60b1faefc2995d8e1ca2faff",
        "aarch64-unknown-linux-musl": "f2ba1c9dbf269e506efa367c0ce30b708d60487a182455fc087280cda76796f7",
        "x86_64-apple-darwin": "77d1edb6a69676cf8e6c2ced749daddf4d8aec179f3195ae0613aef2066abe81",
        "x86_64_v2-unknown-linux-gnu": "4e93f17a52447fc4f22c716322e9a86db83fc90449839d2e7a2c0338849b7a79",
        "x86_64_v2-unknown-linux-musl": "695ae14a62020773fb07b7a64f7e90c0163734c1839f8712277d7f82921c387d",
    },
}

_freebsd_ports_hashes = {
    "py310-sqlite3-3.10.19_10": "b5f9ea064158b99f8ba4d07b29f40248ce53dbc1cbe66b8feb5812579d21b0b7",
    "py311-sqlite3-3.11.14_10": "4204b1ef19e99fc210063537b04c2e6d4726ca5caaf8a86e19c5a1c3f6bd71de",
    "py312-sqlite3-3.12.12_10": "99913911d9344ee9e6295ee94c42bc8249825f8cfa3e763b6a747d2c96ffb4ca",
    "py313-sqlite3-3.13.9_10": "51aa38d1f5f0ee44fb193104ffdd4f3f81980151e177f87ea3af428305e222d1",
    "py314-sqlite3-3.14.0_10": "8065f6f790cc8b2fb053739772b0cb75aa5baf2db1e0a5d1ce102dcf7b181edf",
    "python310-3.10.19": "df2c924f1bf36352139c6c86adef4cca0c5461b1f127ed1cd4a40921402d2a75",
    "python311-3.11.14": "af51ac586e722005655402f8d191d3da60a18825b51afb0b482d2f96161ac32e",
    "python312-3.12.12_2": "9c307087a16a2d01d94a05c27ed124af66b8c7e0b34b55c4973508f3445f45c7",
    "python313-3.13.9": "667931b37d69046191681313fc8283bfca68b1e389bbfc1cfc266a0209134ed3",
    "python314-3.14.0_1": "b6e9e69ed6b0ab92ac47f5f9e1a8e9aaec0534041aa738854d14088b17ba2608",
}

for minor in ["3.10", "3.11", "3.12", "3.13", "3.14"]:
    if CONFIG.OS == "freebsd":
        minorint = int(minor.rpartition(".")[2])

        python_pkg_name = filter(lambda v: v.startswith("python" + minor.replace(".", "") + "-"), _freebsd_ports_hashes.keys())[0]
        python_sqlite3_pkg_name = filter(lambda v: v.startswith("py" + minor.replace(".", "") + "-sqlite3"), _freebsd_ports_hashes.keys())[0]

        python_pkg = remote_file(
            name = tag(f"cpython_{minor}", "python_pkg"),
            url = f"https://pkg.freebsd.org/FreeBSD:14:amd64/latest/All/{python_pkg_name}.pkg",
            hashes = [_freebsd_ports_hashes[python_pkg_name]],
        )

        python_sqlite3_pkg = remote_file(
            name = tag(f"cpython_{minor}", "python_sqlite3_pkg"),
            url = f"https://pkg.freebsd.org/FreeBSD:14:amd64/latest/All/{python_sqlite3_pkg_name}.pkg",
            hashes = [_freebsd_ports_hashes[python_sqlite3_pkg_name]],
        )

        genrule(
            name = f"cpython_{minor}",
            srcs = {
                "python": [python_pkg],
                "python_sqlite3": [python_sqlite3_pkg],
                "setuptools": ["//third_party/python:setuptools"] if minorint < 12 else [],
                "wheel": ["//third_party/python:wheel"] if minorint < 12 else [],
                "pip": ["//third_party/python:pip"],
            },
            outs = [f"python_{minor}"],
            cmd = [
                "mkdir $OUTS",
                "tar -C $OUTS -xf $SRCS_PYTHON --strip-components=3 /usr/local",
                "tar -C $OUTS -xf $SRCS_PYTHON_SQLITE3 --strip-components=3 /usr/local",
                # The contents of FreeBSD Ports packages are designed to be installed beneath /usr/local, so we'll have
                # to do some slightly hacky rpath editing to make sure the Python interpreter can find libpython3.x at
                # run time:
                f"chmod +w $OUTS/bin/python{minor}",
                f"$TOOLS_PATCHELF --set-rpath '$ORIGIN/../lib' $OUTS/bin/python{minor}",
                # Manually download and install pip (and, on Python < 3.12, its dependencies, setuptools and wheel) for
                # each interpreter - ensurepip is stripped out of Ports' python31* packages, and Ports currently
                # contains only a single pip package for the default Python version.
                f"mkdir -p $OUTS/lib/python{minor}/site-packages",
                f"unzip $SRCS_SETUPTOOLS -d $OUTS/lib/python{minor}/site-packages" if minorint < 12 else "true",
                f"unzip $SRCS_WHEEL -d $OUTS/lib/python{minor}/site-packages" if minorint < 12 else "true",
                f"unzip $SRCS_PIP -d $OUTS/lib/python{minor}/site-packages",
            ],
            binary = True,
            entry_points = {
                "python": f"python_{minor}/bin/python{minor}",
            },
            tools = {
                "patchelf": "//third_party/cc/patchelf",
            },
            requires = ["py_whl"],
            visibility = ["PUBLIC"],
        )
    else:
        arch = "aarch64" if CONFIG.ARCH == "arm64" else "x86_64" if CONFIG.OS == "darwin" else "x86_64_v2"
        os = "apple-darwin" if CONFIG.OS == "darwin" else "unknown-linux-musl" if "musl" in CONFIG.PYTHON.FEATURE_FLAGS else "unknown-linux-gnu"
        target = f"{arch}-{os}"
        version = filter(lambda v: v.startswith(f"{minor}."), _python_build_standalone_hashes.keys())[0]

        download = remote_file(
            name = tag(f"cpython_{minor}", "download"),
            url = "https://github.com/astral-sh/python-build-standalone/releases/download/%s/cpython-%s+%s-%s-install_only_stripped.tar.gz" % (
                _python_build_standalone_release,
                version,
                _python_build_standalone_release,
                target,
            ),
            hashes = [_python_build_standalone_hashes[version][target]],
        )

        genrule(
            name = f"cpython_{minor}",
            srcs = [download],
            outs = [f"python_{minor}"],
            cmd = [
                "tar -xf $SRCS",
                "mv python $OUTS",
            ],
            binary = True,
            entry_points = {
                "python": f"python_{minor}/bin/python3",
            },
            visibility = ["PUBLIC"],
        )
